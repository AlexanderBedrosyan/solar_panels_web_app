{% extends 'base.html' %}
{% load static %}

{% block details %}
    <link rel="stylesheet" href="{% static 'pages/project-detail.css' %}">
    <title>Projects</title>
    <meta name="description" content="{{ project.title }} – проект, изпълнен от SolarTronix.">
{% endblock %}

{% block content %}
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loader-container">
            <div class="solar-loader">
                <div class="sun"></div>
                <div class="ray ray1"></div>
                <div class="ray ray2"></div>
                <div class="ray ray3"></div>
                <div class="ray ray4"></div>
            </div>
            <p class="loading-text">Зареждане на проект...</p>
            <div class="loading-progress">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <p class="loading-percentage" id="loading-percentage">0%</p>
        </div>
    </div>

    <div class="container my-5" id="content-card">
        <div>
            <h1 class="display-4">{{ project.title }}</h1>
            <div class="image-wrapper-detail">
                <div class="image-skeleton-detail"></div>
                <img 
                    data-src="{{ project.image_url }}" 
                    alt="project-img" 
                    class="project-detail-image lazy-image-detail"
                    loading="lazy"
                    decoding="async"
                    style="opacity: 0;">
            </div>
            {% if project.secondary_image_url %}
                <div class="image-wrapper-detail">
                    <div class="image-skeleton-detail"></div>
                    <img 
                        data-src="{{ project.secondary_image_url }}" 
                        alt="project-img" 
                        class="project-detail-image lazy-image-detail"
                        loading="lazy"
                        decoding="async"
                        style="opacity: 0;">
                </div>
            {% endif %}
            <p>{{ project.description|linebreaksbr }}</p>
            {% if project.post_url %}
                <div><a href="{{ project.post_url }}" class="text-holder">Повече информация за проекта</a></div>
                <br>
            {% endif %}
            <a href="{% url 'projects' %}" class="btn btn-secondary">Назад към проектите</a>
        </div>
</div>
    
<div id="lightbox-overlay">
    <span id="lightbox-close">&times;</span>
    <img id="lightbox-image" src="" alt="expanded-img">
</div>


    {% include 'common/bottom-view.html' %}
    <script>
// Enhanced loading screen with progress tracking
(function() {
    const loadingScreen = document.getElementById('loading-screen');
    const progressBar = document.getElementById('progress-bar');
    const loadingPercentage = document.getElementById('loading-percentage');
    
    let totalImages = 0;
    let loadedImages = 0;
    
    // Function to update progress
    function updateProgress() {
        const percentage = totalImages > 0 ? Math.round((loadedImages / totalImages) * 100) : 0;
        if (progressBar) {
            progressBar.style.width = percentage + '%';
        }
        if (loadingPercentage) {
            loadingPercentage.textContent = percentage + '%';
        }
    }
    
    // Function to hide loading screen
    function hideLoader() {
        if (loadingScreen) {
            updateProgress(); // Final update to 100%
            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }, 300);
        }
    }

    // Lazy loading implementation
    function lazyLoadImages() {
        const lazyImages = document.querySelectorAll('.lazy-image-detail');
        totalImages = lazyImages.length;
        
        if (totalImages === 0) {
            hideLoader();
            return;
        }
        
        updateProgress();

        // Function to load a single image
        function loadImage(img) {
            return new Promise((resolve, reject) => {
                const imageWrapper = img.closest('.image-wrapper-detail');
                const skeleton = imageWrapper?.querySelector('.image-skeleton-detail');
                
                const actualImg = new Image();
                actualImg.onload = () => {
                    img.src = actualImg.src;
                    img.style.opacity = '1';
                    img.style.transition = 'opacity 0.6s ease-in';
                    
                    // Hide skeleton
                    if (skeleton) {
                        skeleton.style.opacity = '0';
                        setTimeout(() => {
                            skeleton.style.display = 'none';
                        }, 600);
                    }
                    
                    loadedImages++;
                    updateProgress();
                    resolve();
                };
                
                actualImg.onerror = () => {
                    // Even on error, hide skeleton and mark as loaded
                    img.style.opacity = '0.3';
                    if (skeleton) {
                        skeleton.style.display = 'none';
                    }
                    loadedImages++;
                    updateProgress();
                    resolve();
                };
                
                actualImg.src = img.dataset.src;
            });
        }

        // Load all images
        Promise.all(Array.from(lazyImages).map(loadImage))
            .then(() => {
                hideLoader();
            })
            .catch(() => {
                hideLoader();
            });
    }

    // Run when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', lazyLoadImages);
    } else {
        lazyLoadImages();
    }

    // Fallback: hide after 10 seconds maximum
    setTimeout(() => {
        hideLoader();
    }, 10000);
})();

// Lightbox functionality
document.addEventListener("DOMContentLoaded", function () {
    const overlay = document.getElementById("lightbox-overlay");
    const overlayImg = document.getElementById("lightbox-image");
    const closeBtn = document.getElementById("lightbox-close");

    document.querySelectorAll(".project-detail-image").forEach(img => {
        img.style.cursor = "pointer";
        img.addEventListener("click", () => {
            overlayImg.src = img.src;
            overlay.classList.add("active");
        });
    });

    closeBtn.addEventListener("click", () => {
        overlay.classList.remove("active");
    });

    overlay.addEventListener("click", (e) => {
        if (e.target === overlay) {
            overlay.classList.remove("active");
        }
    });
});
</script>

{% endblock %}